from flask import Flask, request, jsonify\nfrom flask_cors import CORS\nfrom flask_restx import Api, Resource, fields\nimport os\nimport jwt\nfrom datetime import datetime, timedelta\nfrom functools import wraps\nimport pymysql\nfrom contextlib import contextmanager\n\napp = Flask(__name__)\nCORS(app)\n\n# Swagger API setup\napi = Api(app, \n    version='1.0', \n    title='Ostrich Service API',\n    description='Service technician mobile app API for Ostrich Product & Service Management System',\n    doc='/docs/'\n)\n\n# Namespaces\nauth_ns = api.namespace('api/v1/auth', description='Authentication operations')\ndashboard_ns = api.namespace('api/v1/dashboard', description='Dashboard operations')\ntickets_ns = api.namespace('api/v1/tickets', description='Ticket operations')\nnotifications_ns = api.namespace('api/v1/notifications', description='Notifications operations')\n\n# Configuration\nSECRET_KEY = os.getenv('SECRET_KEY', 'service-secret-key')\napp.config['SECRET_KEY'] = SECRET_KEY\n\n# Database configuration\nDB_CONFIG = {\n    'host': os.getenv('DB_HOST', 'localhost'),\n    'user': os.getenv('DB_USER', 'root'),\n    'password': os.getenv('DB_PASSWORD', 'your_password_here'),\n    'database': os.getenv('DB_NAME', 'ostrich_db'),\n    'port': int(os.getenv('DB_PORT', 3306)),\n    'charset': 'utf8mb4'\n}\n\n@contextmanager\ndef get_db_connection():\n    connection = None\n    try:\n        connection = pymysql.connect(**DB_CONFIG)\n        yield connection\n    except Exception as e:\n        print(f\"Database connection failed: {e}\")\n        yield None\n    finally:\n        if connection:\n            connection.close()\n\n# JWT utilities\ndef create_access_token(data):\n    payload = data.copy()\n    payload['exp'] = datetime.utcnow() + timedelta(hours=24)\n    return jwt.encode(payload, SECRET_KEY, algorithm=\"HS256\")\n\ndef verify_token(token):\n    try:\n        payload = jwt.decode(token, SECRET_KEY, algorithms=[\"HS256\"])\n        return payload\n    except:\n        return None\n\n# Auth decorator\ndef token_required(f):\n    @wraps(f)\n    def decorated(*args, **kwargs):\n        token = request.headers.get('Authorization')\n        if token and token.startswith('Bearer '):\n            token = token[7:]\n            payload = verify_token(token)\n            if payload:\n                return f(current_user=payload, *args, **kwargs)\n        return jsonify({'error': 'Token required'}), 401\n    return decorated\n\n# Fallback data\nFALLBACK_DATA = {\n    \"technicians\": [\n        {\"id\": 1, \"employee_id\": \"EMP001\", \"full_name\": \"John Technician\", \"email\": \"john.tech@ostrich.com\", \"phone\": \"9876543220\"},\n        {\"id\": 2, \"employee_id\": \"EMP002\", \"full_name\": \"Jane Tech\", \"email\": \"jane.tech@ostrich.com\", \"phone\": \"9876543221\"},\n        {\"id\": 3, \"employee_id\": \"EMP003\", \"full_name\": \"Bob Service\", \"email\": \"bob.tech@ostrich.com\", \"phone\": \"9876543222\"}\n    ],\n    \"tickets\": [\n        {\"id\": 1, \"ticket_number\": \"TKT000001\", \"customer_name\": \"John Customer\", \"customer_phone\": \"9876543210\", \"product_name\": \"3HP Motor\", \"issue_description\": \"Motor not starting\", \"status\": \"SCHEDULED\", \"priority\": \"HIGH\", \"assigned_technician_id\": 1, \"scheduled_date\": \"2025-01-15T10:00:00\"},\n        {\"id\": 2, \"ticket_number\": \"TKT000002\", \"customer_name\": \"Jane Smith\", \"customer_phone\": \"9876543211\", \"product_name\": \"5HP Pump\", \"issue_description\": \"Pump maintenance\", \"status\": \"IN_PROGRESS\", \"priority\": \"MEDIUM\", \"assigned_technician_id\": 1, \"scheduled_date\": \"2025-01-15T14:00:00\"},\n        {\"id\": 3, \"ticket_number\": \"TKT000003\", \"customer_name\": \"Bob Wilson\", \"customer_phone\": \"9876543212\", \"product_name\": \"7HP Generator\", \"issue_description\": \"Generator repair\", \"status\": \"COMPLETED\", \"priority\": \"HIGH\", \"assigned_technician_id\": 2, \"completed_date\": \"2025-01-14T16:30:00\"}\n    ]\n}\n\n# Database helpers\ndef execute_query(query, params=None, fetch_one=False, fetch_all=True):\n    try:\n        with get_db_connection() as conn:\n            if conn:\n                cursor = conn.cursor(pymysql.cursors.DictCursor)\n                cursor.execute(query, params or [])\n                if fetch_one:\n                    return cursor.fetchone()\n                elif fetch_all:\n                    return cursor.fetchall()\n                else:\n                    conn.commit()\n                    return cursor.rowcount\n    except Exception as e:\n        print(f\"Database query failed: {e}\")\n    return None\n\ndef get_technician_tickets(technician_id, status=None):\n    query = \"SELECT * FROM service_tickets WHERE assigned_staff_id = %s\"\n    params = [technician_id]\n    if status:\n        query += \" AND status = %s\"\n        params.append(status)\n    \n    result = execute_query(query, params)\n    if result:\n        return result\n    \n    tickets = [t for t in FALLBACK_DATA[\"tickets\"] if t[\"assigned_technician_id\"] == int(technician_id)]\n    if status:\n        tickets = [t for t in tickets if t[\"status\"].lower() == status.lower()]\n    return tickets\n\n# Models\nlogin_model = api.model('Login', {\n    'username': fields.String(required=True, description='Username'),\n    'password': fields.String(required=True, description='Password')\n})\n\n# Routes\n@app.route('/')\ndef read_root():\n    return jsonify({\n        \"message\": \"Ostrich Service Support API\",\n        \"version\": \"1.0.0\",\n        \"docs\": \"/docs/\",\n        \"status\": \"running\"\n    })\n\n@app.route('/health')\ndef health_check():\n    return jsonify({\n        \"status\": \"healthy\", \n        \"service\": \"ostrich-service-api\"\n    })\n\n@auth_ns.route('/login')\nclass Login(Resource):\n    @auth_ns.expect(login_model)\n    def post(self):\n        \"\"\"Technician login with username/password\"\"\"\n        data = request.get_json()\n        username = data.get('username')\n        password = data.get('password')\n        \n        if username == \"demo.tech\" and password == \"password123\":\n            access_token = create_access_token({\"sub\": \"1\", \"username\": username})\n            return {\n                \"access_token\": access_token,\n                \"technician_id\": 1,\n                \"full_name\": \"John Technician\",\n                \"role\": \"technician\"\n            }\n        return {\"detail\": \"Invalid username or password\"}, 401\n\n@dashboard_ns.route('/')\nclass Dashboard(Resource):\n    @dashboard_ns.doc('get_dashboard')\n    @token_required\n    def get(self, current_user):\n        \"\"\"Get technician dashboard with assigned tickets and stats\"\"\"\n        technician_id = current_user.get('sub', '1')\n        assigned_tickets = get_technician_tickets(technician_id, 'SCHEDULED')\n        in_progress_tickets = get_technician_tickets(technician_id, 'IN_PROGRESS')\n        completed_tickets = get_technician_tickets(technician_id, 'COMPLETED')\n        \n        return {\n            \"stats\": {\n                \"assigned_tickets\": len(assigned_tickets),\n                \"completed_today\": len([t for t in completed_tickets if t.get('completed_date', '').startswith(datetime.now().strftime('%Y-%m-%d'))]),\n                \"pending_tickets\": len(assigned_tickets),\n                \"in_progress\": len(in_progress_tickets)\n            },\n            \"recent_tickets\": (assigned_tickets + in_progress_tickets)[:5]\n        }\n\n@tickets_ns.route('/assigned')\nclass AssignedTickets(Resource):\n    @tickets_ns.doc('get_assigned_tickets')\n    @token_required\n    def get(self, current_user):\n        \"\"\"Get tickets assigned to technician with filters\"\"\"\n        technician_id = current_user.get('sub', '1')\n        status = request.args.get('status')\n        priority = request.args.get('priority')\n        \n        tickets = get_technician_tickets(technician_id)\n        \n        if status:\n            tickets = [t for t in tickets if t.get('status', '').lower() == status.lower()]\n        if priority:\n            tickets = [t for t in tickets if t.get('priority', '').lower() == priority.lower()]\n        \n        return {\n            \"tickets\": tickets,\n            \"total_count\": len(tickets)\n        }\n\n# Additional Flask routes for remaining endpoints\n@app.route('/api/v1/tickets/<int:ticket_id>', methods=['GET'])\n@token_required\ndef get_ticket_details(ticket_id, current_user):\n    \"\"\"Get detailed ticket information\"\"\"\n    technician_id = current_user.get('sub', '1')\n    tickets = get_technician_tickets(technician_id)\n    ticket = next((t for t in tickets if t.get('id') == ticket_id), None)\n    \n    if not ticket:\n        return jsonify({\"error\": \"Ticket not found\"}), 404\n    \n    return jsonify(ticket)\n\n@app.route('/api/v1/tickets/<int:ticket_id>/status', methods=['PUT'])\n@token_required\ndef update_ticket_status(ticket_id, current_user):\n    \"\"\"Update ticket status and notes\"\"\"\n    data = request.get_json()\n    status = data.get('status', '').upper()\n    notes = data.get('notes', '')\n    \n    return jsonify({\n        \"message\": \"Ticket status updated successfully\",\n        \"ticket_id\": ticket_id,\n        \"new_status\": status,\n        \"updated_at\": datetime.now().isoformat(),\n        \"notes\": notes\n    })\n\n@app.route('/api/v1/tickets/<int:ticket_id>/location', methods=['POST'])\n@token_required\ndef capture_location(ticket_id, current_user):\n    \"\"\"Capture location for ticket\"\"\"\n    latitude = request.args.get('latitude', type=float)\n    longitude = request.args.get('longitude', type=float)\n    \n    return jsonify({\n        \"message\": \"Location captured successfully\",\n        \"ticket_id\": ticket_id,\n        \"latitude\": latitude,\n        \"longitude\": longitude,\n        \"captured_at\": datetime.now().isoformat()\n    })\n\nif __name__ == '__main__':\n    port = int(os.getenv(\"PORT\", 8002))\n    app.run(host=\"0.0.0.0\", port=port, debug=True)